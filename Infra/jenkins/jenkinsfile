pipeline {
  agent {
    kubernetes {
      label 'default'
      defaultContainer 'jnlp'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: jnlp
      image: 935875533840.dkr.ecr.ap-northeast-2.amazonaws.com/jenkins-agent-with-docker:latest
      imagePullPolicy: Always
      tty: true
  imagePullSecrets:
    - name: ecr-secret
"""
    }
  }

  environment {
    AWS_REGION = 'ap-northeast-2'
    AWS_ACCOUNT_ID = '935875533840'
    ECR_BASE = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Git에서 소스코드 체크아웃"
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/xxoznge/golang-grpc-chat.git',
            credentialsId: 'github-pat'
          ]]
        ])
      }
    }

    stage('Login to AWS ECR') {
      steps {
        echo "ECR 로그인 (세션 토큰 포함)"
        withCredentials([
          string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
          string(credentialsId: 'aws-session-token', variable: 'AWS_SESSION_TOKEN')
        ]) {
          sh """
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
            aws configure set aws_session_token $AWS_SESSION_TOKEN
            aws configure set default.region ${AWS_REGION}
            aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_BASE}
          """
        }
      }
    }

    stage('Build & Push grpc-chat-server') {
      steps {
        echo "grpc-chat-server Build & Push"
        dir('.') {
          script {
            def imageName = "${ECR_BASE}/grpc-chat-server:${env.BUILD_NUMBER}"
            sh "docker build -t ${imageName} ."
            sh "docker push ${imageName}"
          }
        }
      }
    }

    stage('Build & Push web-chat') {
      steps {
        echo "web-chat Build & Push"
        dir('web-chat') {
          script {
            def imageName = "${ECR_BASE}/web-chat:${env.BUILD_NUMBER}"
            sh "docker build -t ${imageName} ."
            sh "docker push ${imageName}"
          }
        }
      }
    }

    stage('Build & Push ws-proxy') {
      steps {
        echo "ws-proxy Build & Push"
        dir('ws-proxy') {
          script {
            def imageName = "${ECR_BASE}/ws-proxy:${env.BUILD_NUMBER}"
            sh "docker build -t ${imageName} ."
            sh "docker push ${imageName}"
          }
        }
      }
    }
  }

  post {
    success {
      echo '이미지 ECR Push 완료'
    }
    failure {
      echo '이미지 ECR Push 실패'
    }
  }
}
