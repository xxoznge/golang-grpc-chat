def JOBS = [
  [name: "kaniko-job-server", path: "Infra/kaniko/kaniko-job-server.yaml"],
  [name: "kaniko-job-web", path: "Infra/kaniko/kaniko-job-web.yaml"],
  [name: "kaniko-job-ws", path: "Infra/kaniko/kaniko-job-ws.yaml"]
]

pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps {
        echo "[단계] Git에서 소스코드 체크아웃"
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/xxoznge/golang-grpc-chat.git',
            credentialsId: 'github-pat'
          ]]
        ])
      }
    }

    stage('Run Kaniko Jobs') {
      steps {
        script {
          for (job in JOBS) {
            echo "[단계] ${job.name} 실행 중"
            sh "kubectl delete job ${job.name} --ignore-not-found"
            sh "kubectl apply -f ${job.path}"
            sh """
              echo "[대기] ${job.name} Job 완료까지 대기 중..."
              kubectl wait --for=condition=complete --timeout=300s job/${job.name} || (
                echo '[오류] ${job.name} 실패. 로그 출력:' && \
                kubectl logs job/${job.name} && \
                exit 1
              )
            """
          }
        }
      }
    }
  }

  post {
    success {
      echo '[성공] 모든 Kaniko Job 완료'
    }
    failure {
      echo '[실패] 일부 Kaniko Job 실패'
    }
  }
}
