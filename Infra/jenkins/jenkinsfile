pipeline {
  agent any

  environment {
    EC2_HOST = "ec2-user@15.164.240.40"
    SSH_KEY_ID = "ec2-ssh-key" 
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Git에서 소스코드 체크아웃"
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/xxoznge/golang-grpc-chat.git',
            credentialsId: 'github-pat'
          ]]
        ])
      }
    }

    stage('Trigger EC2 Docker Build') {
      steps {
        echo "EC2에 SSH 접속하여 build_and_push.sh 실행"
        sshagent(credentials: [SSH_KEY_ID]) {
          sh """
            ssh -o StrictHostKeyChecking=no ${EC2_HOST} '~/build_and_push.sh ${BUILD_NUMBER}'
          """
        }
      }
    }
  }

  post {
    success {
      echo 'EC2에서 Docker 이미지 빌드 및 ECR 푸시 성공'
    }
    failure {
      echo 'EC2 빌드 실패 또는 SSH 접속 실패'
    }
  }
}

